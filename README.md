# TEST Squadron Discord Bot

Welcome to the **TEST Squadron Discord Bot** repository. This bot helps manage user verification within our Discord server and provides advanced voice channel management features. The codebase has been optimized for both human maintainability and AI agent comprehension.

## üöÄ Features

- **Token-Based Verification:** Users receive a unique token to verify their membership.
- **Role Assignment:** Automatically assigns roles based on verification status.
- **Cooldown System:** Limits verification attempts to prevent spam and abuse.
- **Voice Channel Management:** Users can create, manage, and customize their own voice channels.
- **Persistent Settings:** User channel settings are stored in a database for a consistent experience.
- **Interactive Modals and Views:** Provides an interactive user experience with Discord's UI components.
- **Persistent Verification Message:** The bot keeps a single verification message in the verification channel ‚Äî it stores the message ID in `verification_message_id.json` and will reuse that message instead of creating duplicates. It does not currently delete old messages on startup.
- **Error Handling and Logging:** Gracefully handles permission issues and logs errors for debugging.
- **ü§ñ AI-Agent Optimizations:** Structured prompts, schemas, defensive retry patterns, and comprehensive type safety for AI development assistance.

## üèóÔ∏è Architecture Overview

### Core Components

- **`bot.py`**: The main bot script initializing the bot, loading environment variables, configuration, and setting up logging.
- **`config/`**: Configuration management with type-safe loading
  - **`config.yaml`**: Stores bot configurations such as command prefix, rate limits, and organization name.
- **`cogs/`**: Discord.py command modules
  - **`verification.py`**: Handles user verification process
  - **`voice.py`**: Voice channel management system
  - **`admin.py`**: Administrative commands
- **`helpers/`**: Utility modules for common functionality
  - **`defensive_retry.py`**: üÜï Robust retry mechanisms with exponential backoff
  - **`structured_errors.py`**: üÜï AI-friendly error reporting and analysis
  - **`schema_validation.py`**: üÜï JSON schema validation for data consistency
- **`prompts/`**: üÜï AI-agent friendly templates and schemas
  - **`schemas/`**: JSON schemas for data validation
  - **`messages/`**: User-facing message templates
  - **`system/`**: Development and debugging templates
- **`verification/`**: RSI verification logic
- **`data/`**: Data models and database interfaces
  - **`config_loader.py`**: Handles loading and providing access to configuration data.
- **`cogs/`**
  - **`verification.py`**: Handles the verification process, including sending the initial verification message, token generation, and role assignment.
  - **`admin.py`**: Provides administrative commands for bot admins and moderators.
  - **`voice.py`**: Manages dynamic voice channels, including creation, customization, and deletion.
  - **`__init__.py`**: Package initializer.
- **`helpers/`**
  - **`database.py`**: Manages database connections and operations.
  - **`embeds.py`**: Functions for creating various embedded messages, such as error and success messages.
  - **`token_manager.py`**: Manages tokens for user verification, including token generation, validation, and expiration.
  - **`http_helper.py`**: Handles HTTP requests for RSI verification.
  - **`role_helper.py`**: Centralizes role assignment logic.
  - **`modals.py`**: Contains modal classes for interactive user inputs.
  - **`views.py`**: Contains view classes for interactive components like buttons and dropdowns.
  - **`permissions_helper.py`**: Helps manage permissions for voice channels.
  - **`voice_utils.py`**: Utility functions for voice channel management.
  - **`rate_limiter.py`**: Manages rate limiting for commands and actions.
  - **`logger.py`**: Sets up logging configurations and custom formatters.
  - **`__init__.py`**: Package initializer.
- **`verification/`**
  - **`rsi_verification.py`**: Implements RSI (Star Citizen) verification by interacting with RSI profiles and checking for organizational membership and token presence in the user‚Äôs bio.
  - **`__init__.py`**: Package initializer.
- **`docs/`**: Contains external documentation generated by Sphinx.
- **`data/`**
  - **`__init__.py`**: Reserved for future data storage needs.
- **`requirements.txt`**: Lists the dependencies required for the project.
- **`SETUP.txt`**: Guide on setting up the bot locally, including instructions for configuring environment variables.
- **`Commands.txt`**: List of available commands.

## üõ†Ô∏è Getting Started

### Discord Bot Permissions

The bot requires specific Discord permissions to function properly. **Do not grant Administrator permissions** - instead, grant only these specific permissions for security:

#### Required Permissions:
- **View Channels** - Read messages and see channels
- **Send Messages** - Send responses and notifications  
- **Embed Links** - Send rich embed messages
- **Read Message History** - Access previous messages for context
- **Use Slash Commands** - Register and respond to slash commands
- **Manage Roles** - Assign verification and member roles
- **Manage Channels** - Create/delete voice channels and manage categories
- **Connect** - Connect to voice channels
- **Move Members** - Move users between voice channels
- **Change Nickname** - Update user nicknames during verification
- **Manage Nicknames** - Update other users' nicknames

#### Permission Setup:
1. Go to your Discord server settings
2. Navigate to Roles ‚Üí [Bot Role]
3. Enable only the permissions listed above
4. Ensure the bot's role is positioned high enough to manage the roles it needs to assign
5. For voice categories: Right-click the voice category ‚Üí Edit Category ‚Üí Permissions ‚Üí Add bot role with "Manage Channels" permission

#### Role Configuration:
Configure admin roles in `config/config.yaml`:
```yaml
roles:
  bot_admins: [123456789012345678]  # Role IDs that can use admin commands
  lead_moderators: [987654321098765432]  # Additional elevated roles
```

### Admin Commands

The bot includes several administrative commands for configuration and management. All admin commands require users to have either the **Bot Admin** or **Lead Moderator** role configured in `config/config.yaml`.

#### General Admin Commands (`/admin` group)

| Command | Description | Required Role | Usage |
|---------|-------------|---------------|-------|
| `/status` | Show detailed bot health and status information | Bot Admin / Lead Moderator | `/status detailed:true` |
| `/guild-config` | Show current guild configuration (roles, channels, voice settings) | Bot Admin / Lead Moderator | `/guild-config` |
| `/set-config` | Set a guild configuration value | Bot Admin / Lead Moderator | `/set-config key:"voice.cooldown_seconds" value:"30"` |

#### Voice Admin Commands (`/voice` group)

| Command | Description | Required Role | Usage |
|---------|-------------|---------------|-------|
| `/voice setup` | Set up voice channel system (create JTC channels and category) | Bot Admin | `/voice setup category:#Voice-Channels num_channels:2` |
| `/voice admin_reset` | Reset a user's voice channel settings | Bot Admin / Lead Moderator | `/voice admin_reset user:@username` |
| `/voice admin_list` | View saved voice channel settings for a user | Bot Admin / Lead Moderator | `/voice admin_list user:@username` |

#### Configuration Examples

**Setting Voice Cooldown:**
```
/set-config key:"voice.cooldown_seconds" value:"30"
```

**Setting Custom Voice Settings:**
```
/set-config key:"voice.max_channels_per_user" value:"3"
/set-config key:"voice.channel_name_template" value:"{user}'s Channel"
```

**Viewing Current Configuration:**
```
/guild-config
```

**Setting Up Voice System:**
```
/voice setup category:#Voice-Channels num_channels:3
```

### Permission System

The bot uses a **role-based permission system** rather than Discord's built-in Administrator permission for security:

#### Role Hierarchy:
1. **Bot Admin** - Full administrative access to all bot functions
2. **Lead Moderator** - Administrative access to most functions (excluding some sensitive operations)
3. **Regular Users** - Access to user-facing commands only

#### Permission Checks:
- Commands check for specific role IDs configured in `config/config.yaml`
- Multiple roles can be assigned the same permissions
- Role checks are performed on every command execution
- No Discord Administrator permission is required or recommended

#### Security Benefits:
- **Principle of Least Privilege**: Users only get necessary permissions
- **Granular Control**: Different roles can have different permission levels
- **Audit Trail**: All admin actions are logged with user information
- **No Overreach**: Bot cannot perform server-wide admin actions

For detailed setup instructions, refer to `SETUP.txt` in the repository or the documentation source files under `docs/` (for example, `docs/verification_workflow.md`).

## üìÑ Documentation

Comprehensive documentation is available and includes:

- **Modules Documentation**: Detailed explanations of each module and its components.
- **Usage Instructions**: Step-by-step guides on how to use the bot.
- **Setup Instructions**: Instructions on setting up the bot locally.
- **Troubleshooting**: Solutions to common issues.

Developer documentation source is included in the `docs/` directory (markdown files). The generated Sphinx HTML (`docs/build/html/...`) is not committed to this repository.

If you prefer to view HTML docs locally, build them from the Sphinx sources on your machine (see "Building docs locally" below) ‚Äî otherwise read the markdown files in `docs/`.